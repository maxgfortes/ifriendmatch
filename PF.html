<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iFriendMatch</title>
  <link rel="icon" href="./src/icon/icon.png" type="image/png" />
  <meta name="theme-color" content="#1F1F1F" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./src/icon/icon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="./src/styles/base.css" />
  <link rel="stylesheet" href="./src/styles/layout.css" />
  <link rel="stylesheet" href="./src/styles/components.css" />
  <link rel="stylesheet" href="./src/styles/media-queries.css" />
  <link rel="stylesheet" href="./src/styles/navbars.css" />
    <link rel="stylesheet" href="./src/styles/profile.css" />
    <link rel="stylesheet" href="./src/styles/tags.css" />
    <link rel="stylesheet" href="./src/styles/mobile.css" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
 <div class="glass-overlay"></div>

  <!-- Navbar -->
  <nav>
    <div class="logo_area">
      <div class="logo">RealMe</div>
    </div>
<div class="search-area">
  <div class="search-box">
    <button><i class="fas fa-search"></i></button>
    <input type="text" id="searchInput" placeholder="Buscar" autocomplete="off"  />
  </div>
</div>

    <div class="last-update-area">
      <div class="last-update">
        <p>Novidades!</p>
      </div>
    </div>
    <div class="marquee-container">
      <div class="marquee">Blessed_ranixw acabou de entrar no RealMe!</div>
    </div>
  </nav>

  <!-- Sidebar Desktop -->
  <aside class="sidebar">
    <a href="feed.html"><i class="fas fa-home"></i> Início</a>
    <a href="aa.html"><i class="fas fa-user-friends"></i> Achar Amigos</a>
    <a href="dm.html"><i class="fas fa-comments"></i> Mensagens</a>
    <a href="nt.html"><i class="fas fa-bell"></i> Notificações</a>
    <a href="#" onclick="openPostOverlay()"><i class="fas fa-plus-square"></i> Criar</a>
    <a href="#" id="linkPerfilSidebar"><i class="fas fa-user"></i> Perfil</a>
    <a href="config.html"><i class="fas fa-cog"></i> Configurações</a>
    <a href="#" id="btnSair"><i class="fas fa-sign-out-alt"></i> Sair</a>
  </aside>
  
  <ul id="searchResults"></ul>

  <!-- Navbar Bottom (Mobile) -->
  <div class="navbar-bottom">
    <div class="navbar-bottom-content">
      <a href="iFeed.html"><i class="fas fa-home"></i></a>
      <a href="#"><i class="fas fa-user-friends"></i></a>
      <a href="#"><i class="fas fa-comments"></i></a>
      <a href="PF.html" id="linkPerfilMobile"><i class="fas fa-user"></i></a>
      <a href="config.html"><i class="fas fa-cog"></i></a>
    </div>
  </div>

<div class="full-profile-container">

  <!-- Topo do perfil -->
  <div class="profile-header">
    <div class="profile-pic-block">
      <img src="./src/icon/default.jpg" alt="Foto de perfil" class="profile-pic" />
    </div>
    
    <div class="profile-info-block">
      <div class="name-line">
        <h2 class="profile-name" id="nomeCompleto">usuario do RealMe</h2>
        <div class="tag-area">
          <span class="tag" data-id="1">Y2K</span>
          <span class="tag" data-id="2">Goth</span>
          <span class="tag" data-id="3">Dev</span>
          <span class="tag" data-id="4">Emo</span>
          <span class="tag" data-id="5">cute</span>
          <span class="tag" data-id="6">Alt</span>
          <span class="tag" data-id="7">Dark</span>
          <span class="tag" data-id="8">loser</span>
          <span class="tag" data-id="9">Skins</span>
          <!-- ...até 50 -->
        </div>
      </div>
      <div class="handle" id="username">@username</div>

      <div class="profile-stats">
        <span><strong>0</strong> posts</span>
        <span><strong>0</strong> seguidores</span>
        <span><strong>0</strong> amigos</span>
        <span><strong>0</strong> seguindo</span>
      </div>
      <div class="action-buttons">
        <button class="btn-follow">seguir</button>
        <button class="btn-message">mensagem</button>
        <button class="btn-nudge"><i class="fa-solid fa-bell ringing-bell"></i><p>nudge</p></button>
      </div>
    </div>
  </div>

  <!-- Corpo do perfil -->
  <div class="profile-body">
    <!-- Sidebar -->
    <div class="profile-menu-area">
      <div class="profile-menu">
      <button class="menu-item active"><i class="fas fa-paper-plane"></i> <p>mural</p></button> <!-- Ativo por padrão -->
      <button class="menu-item"><i class="fas fa-comment-dots"></i><p>Visão Geral</p></button>
      <button class="menu-item"><i class="fas fa-heart"></i><p>Gostos</p></button>
      <button class="menu-item"><i class="fas fa-comments"></i><p>Depoimentos</p></button>
      <button class="menu-item"><i class="fas fa-link"></i><p>links</p></button>
      </div>
    </div>

    <!-- Conteúdo dinâmico -->
    <div class="tab mural-tab active">
       <h3 class="tab-info" id="tituloMural">Mural de </h3>
      <div class="status-box">
        <p><strong>Este Usuario está:</strong></p>
        <p class="status-text">Online</p>
      </div>

      <div id="muralPosts" class="post-grid">
        <div class="post-card">
          <div class="post-header">
            <div class="profile-post-info">
              <img src="./src/icon/default.jpg" alt="Foto de perfil" class="user-pic">
              <span class="username">Seu Usuario</span>
           </div>
           <i class="fas fa-ellipsis-h dots"></i>
          </div>
          <div class="post-content">
            <p>Este é um post de testes dos devs do realme</p>
            <!-- <img src="imagem.jpg" alt="Postagem" class="post-image"> -->
          </div>
          <div class="post-footer">
          <div class="post-actions">
            <button><i class="fas fa-heart"></i></button>
            <button><i class="fas fa-bookmark"></i></button>
          </div>
          <span class="post-date">23 de julho de 2025</span>
        </div>
      </div>

        <div class="post-card">
          <div class="post-header">
            <div class="profile-post-info">
              <img src="./src/icon/default.jpg" alt="Foto de perfil" class="user-pic">
              <span class="username">Seu Usuario</span>
           </div>
           <i class="fas fa-ellipsis-h dots"></i>
          </div>
          <div class="post-content">
            <p>Este é um post de testes dos devs do realme</p>
            <!-- <img src="imagem.jpg" alt="Postagem" class="post-image"> -->
          </div>
          <div class="post-footer">
          <div class="post-actions">
            <button><i class="fas fa-heart"></i></button>
            <button><i class="fas fa-bookmark"></i></button>
          </div>
          <span class="post-date">23 de julho de 2025</span>
        </div>
      </div>

              <div class="post-card">
          <div class="post-header">
            <div class="profile-post-info">
              <img src="./src/icon/default.jpg" alt="Foto de perfil" class="user-pic">
              <span class="username">Seu Usuario</span>
           </div>
           <i class="fas fa-ellipsis-h dots"></i>
          </div>
          <div class="post-content">
            <p>Este é um post de testes dos devs do realme</p>
            <!-- <img src="./src/posts/post1.png" alt="Postagem" class="post-image"> !-->
          </div>
          <div class="post-footer">
          <div class="post-actions">
            <button><i class="fas fa-heart"></i></button>
            <button><i class="fas fa-bookmark"></i></button>
          </div>
          <span class="post-date">23 de julho de 2025</span>
        </div>
      </div>

      </div>
    </div>
    <div class="tab visao-tab">
      <h3 id="visao-geral-title">Visão Geral desse usuario</h3>
      <div class="about-container">
        <div class="about-box">
          <p><i>Visão geral:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Sobre mim:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Meu Estilo:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Minha personalidade:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Meus Sonhos e desejos:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Meus Medos:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
      </div>
    </div>
    <div class="tab gostos-tab">
      <h3 id="gostos-title">Gostos desse usuario</h3>
       <div class="about-container">
        <div class="about-box">
          <p><i>Musicas:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Filmes e Series</i>:</p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Livros:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Personagens:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Comidas e Bebidas:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Hobbies:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Jogos favoritos:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
        <div class="about-box">
          <p><i>Outros gostos:</i></p>
          <p>esta opção nao esta disponível no momento...</p>
        </div>
      </div>
    </div>
    <div class="tab deps-tab">
      <h3 id="tituloMural">Depoimentos desse usuario</h3>
             <div class="about-container">
        <div class="about-box">
          <h2>esta opção não esta disponível no momento...</h2>
        </div>
      </div>
    </div>
    <div class="tab links-tab">
      <h3 id="tituloMural">Links  desse usuario</h3>
      <div class="about-container">
        <div class="link-box">
          <a href="#">Nenhum Link Disponivel</a>
        </div>
      </div>
    </div>
  </div>
</div>

    <div class="container">
    <div class="overlay">
      <div class="text">Realme</div>
      <div class="overlay-message">Disponível apenas em computadores.</div>
    </div>
  </div>

<div class="post-modal" id="postModal">
  <div class="post-modal-content">
    <button class="close-post-modal" onclick="closePostOverlay()"><i class="fas fa-times"></i></button>
    <h2>Fazer Nova <span>Postagem</span>!</h2>

    <textarea id="postText" placeholder="Compartilhe algo..."></textarea>

    <label class="file-input-label">
      <i class="fas fa-image"></i> Adicionar imagem
      <input type="file" id="postImageInput" accept="image/*" />
    </label>

    <div id="imagePreview" class="image-preview"></div>
    <button id="removeImageBtn" class="remove-image-btn" style="display:none;" onclick="removeImage()">Remover Imagem</button>


    <button class="submit-post-btn" onclick="submitPost()">Postar!</button>
  </div>
  
</div>
  <script src="./src/js/profile.js" defer></script>
  <script src="./src/js/search.js" defer></script>
  <script src="/js/mobile-lock.js"></script>
<script type="module">
// ===================
// SISTEMA DE LIVE STATUS AUTOMÁTICO INTEGRADO
// ===================

import { 
  getDatabase, 
  ref, 
  onValue, 
  set, 
  onDisconnect, 
  serverTimestamp,
  off
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  startAt,
  endAt,
  getDocs,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2N41DiH0-Wjdos19dizlWSKOlkpPuOWs",
  authDomain: "ifriendmatch.firebaseapp.com",
  projectId: "ifriendmatch",
  storageBucket: "ifriendmatch.appspot.com",
  messagingSenderId: "306331636603",
  appId: "1:306331636603:web:c0ae0bd22501803995e3de",
  measurementId: "G-D96BEW6RC3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

// ===================
// CLASSE LIVE STATUS MANAGER
// ===================
class LiveStatusManager {
  constructor(username) {
    this.username = username;
    this.currentPage = this.getCurrentPage();
    this.statusRef = ref(rtdb, `userStatus/${username}`);
    this.heartbeatInterval = null;
    this.lastActivity = Date.now();
    this.isTabActive = true;
    this.awayTimeout = null;
    
    this.init();
  }

  init() {
    this.setupPresenceSystem();
    this.setupActivityTracking();
    this.setupPageTracking();
    this.setupVisibilityTracking();
    this.startHeartbeat();
    this.monitorUserStatus();
  }

  getCurrentPage() {
    const path = window.location.pathname;
    const page = path.split('/').pop() || 'index.html';
    
    const pageMap = {
      'index.html': 'Login',
      'feed.html': 'Feed',
      'PF.html': 'Perfil',
      'config.html': 'Configurações',
      'chat.html': 'Chat',
      'search.html': 'Busca'
    };

    return pageMap[page] || page.replace('.html', '');
  }

  setupPresenceSystem() {
    const statusData = {
      username: this.username,
      status: 'online',
      lastSeen: serverTimestamp(),
      currentPage: this.currentPage,
      timestamp: serverTimestamp()
    };

    set(this.statusRef, statusData);

    onDisconnect(this.statusRef).set({
      username: this.username,
      status: 'offline',
      lastSeen: serverTimestamp(),
      currentPage: this.currentPage,
      timestamp: serverTimestamp()
    });

    const connectedRef = ref(rtdb, '.info/connected');
    onValue(connectedRef, (snapshot) => {
      if (snapshot.val() === true) {
        console.log('✅ Conectado ao Firebase Realtime');
        set(this.statusRef, {
          ...statusData,
          status: this.isTabActive ? 'online' : 'away',
          timestamp: serverTimestamp()
        });
      }
    });
  }

  setupActivityTracking() {
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    
    const updateActivity = () => {
      this.lastActivity = Date.now();
      if (this.awayTimeout) {
        clearTimeout(this.awayTimeout);
      }
      
      if (this.isTabActive) {
        this.setStatus('online');
      }
      
      this.awayTimeout = setTimeout(() => {
        if (this.isTabActive) {
          this.setStatus('away');
        }
      }, 5 * 60 * 1000); // 5 minutos
    };

    activityEvents.forEach(event => {
      document.addEventListener(event, updateActivity, true);
    });
  }

  setupPageTracking() {
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;

    history.pushState = (...args) => {
      originalPushState.apply(history, args);
      this.updateCurrentPage();
    };

    history.replaceState = (...args) => {
      originalReplaceState.apply(history, args);
      this.updateCurrentPage();
    };

    window.addEventListener('popstate', () => {
      this.updateCurrentPage();
    });
  }

  setupVisibilityTracking() {
    document.addEventListener('visibilitychange', () => {
      this.isTabActive = !document.hidden;
      
      if (this.isTabActive) {
        this.setStatus('online');
        this.lastActivity = Date.now();
      } else {
        this.setStatus('away');
      }
    });

    window.addEventListener('beforeunload', () => {
      this.setStatus('offline');
    });

    window.addEventListener('focus', () => {
      this.isTabActive = true;
      this.setStatus('online');
    });

    window.addEventListener('blur', () => {
      this.isTabActive = false;
      this.setStatus('away');
    });
  }

  startHeartbeat() {
    this.heartbeatInterval = setInterval(() => {
      if (this.isTabActive) {
        this.updateHeartbeat();
      }
    }, 30000);
  }

  updateCurrentPage() {
    const newPage = this.getCurrentPage();
    if (newPage !== this.currentPage) {
      this.currentPage = newPage;
      this.updateHeartbeat();
    }
  }

  updateHeartbeat() {
    const now = Date.now();
    const timeSinceActivity = now - this.lastActivity;
    
    let status = 'online';
    if (!this.isTabActive) {
      status = 'away';
    } else if (timeSinceActivity > 5 * 60 * 1000) {
      status = 'away';
    }

    set(this.statusRef, {
      username: this.username,
      status: status,
      lastSeen: serverTimestamp(),
      currentPage: this.currentPage,
      timestamp: serverTimestamp(),
      heartbeat: now
    });
  }

  setStatus(status) {
    set(this.statusRef, {
      username: this.username,
      status: status,
      lastSeen: serverTimestamp(),
      currentPage: this.currentPage,
      timestamp: serverTimestamp()
    });
  }

  // Monitorar status do usuário sendo visualizado
  monitorUserStatus() {
    const params = new URLSearchParams(window.location.search);
    const usernameParam = params.get("username") || params.get("user");
    
    if (usernameParam && usernameParam !== this.username) {
      const targetUserRef = ref(rtdb, `userStatus/${usernameParam}`);
      onValue(targetUserRef, (snapshot) => {
        if (snapshot.exists()) {
          this.updateStatusDisplay(snapshot.val());
        } else {
          this.updateStatusDisplay({ status: 'offline' });
        }
      });
    }
  }

  updateStatusDisplay(statusData) {
    const statusBox = document.querySelector('.status-box');
    const statusText = document.querySelector('.status-text');
    
    if (!statusBox || !statusText) return;

    const { status, lastSeen, currentPage } = statusData;
    let displayText = '';
    let statusClass = '';

    switch (status) {
      case 'online':
        displayText = currentPage ? `Online • ${currentPage}` : 'Online';
        statusClass = 'online';
        break;
      case 'away':
        displayText = currentPage ? `Ausente • ${currentPage}` : 'Ausente';
        statusClass = 'away';
        break;
      case 'offline':
        const lastSeenText = this.formatLastSeen(lastSeen);
        displayText = `Offline • ${lastSeenText}`;
        statusClass = 'offline';
        break;
      default:
        displayText = 'Status desconhecido';
        statusClass = 'offline';
    }

    statusText.textContent = displayText;
    statusText.className = `status-text ${statusClass}`;

    // Adicionar indicador visual
    const indicator = statusBox.querySelector('.status-indicator') || this.createStatusIndicator();
    indicator.className = `status-indicator ${statusClass}`;
    
    if (!statusBox.querySelector('.status-indicator')) {
      statusBox.querySelector('p:first-child').appendChild(indicator);
    }
  }

  createStatusIndicator() {
    const indicator = document.createElement('span');
    indicator.className = 'status-indicator';
    indicator.style.cssText = `
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 8px;
      animation: pulse 2s infinite;
    `;
    return indicator;
  }

  formatLastSeen(timestamp) {
    if (!timestamp) return 'há muito tempo';
    
    const now = Date.now();
    const lastSeen = typeof timestamp === 'number' ? timestamp : timestamp.seconds * 1000;
    const diff = now - lastSeen;
    
    if (diff < 60000) return 'agora mesmo';
    if (diff < 3600000) return `há ${Math.floor(diff / 60000)} min`;
    if (diff < 86400000) return `há ${Math.floor(diff / 3600000)}h`;
    return `há ${Math.floor(diff / 86400000)}d`;
  }

  destroy() {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
    if (this.awayTimeout) {
      clearTimeout(this.awayTimeout);
    }
    this.setStatus('offline');
  }
}

// ===================
// FUNCIONALIDADE DE BUSCA
// ===================
const searchInput = document.getElementById('searchInput');
const resultsList = document.getElementById('searchResults');
const searchButton = document.querySelector('.search-box button');

if (searchInput && resultsList && searchButton) {
  async function performSearch() {
    const term = searchInput.value.trim().toLowerCase();
    resultsList.innerHTML = '';
    resultsList.classList.remove('visible');

    if (!term) return;

    const usersRef = collection(db, 'users');
    const q = query(usersRef, orderBy('username'), startAt(term), endAt(term + '\uf8ff'));

    try {
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        resultsList.innerHTML = '<li>Nenhum usuário encontrado</li>';
        resultsList.classList.add('visible');
        return;
      }

      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        const li = document.createElement('li');
        li.textContent = user.username;
        li.addEventListener('click', () => {
          window.location.href = `PF.html?username=${user.username}`;
        });
        resultsList.appendChild(li);
      });

      resultsList.classList.add('visible');
    } catch (err) {
      console.error('Erro na busca:', err);
      resultsList.innerHTML = '<li>Erro na busca</li>';
      resultsList.classList.add('visible');
    }
  }

  searchButton.addEventListener('click', (e) => {
    e.preventDefault();
    performSearch();
  });

  searchInput.addEventListener('input', performSearch);

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-area')) {
      resultsList.classList.remove('visible');
    }
  });
}

// ===================
// DETERMINAR QUAL USUÁRIO CARREGAR
// ===================
function determinarUsuarioParaCarregar() {
  const params = new URLSearchParams(window.location.search);
  const usernameParam = params.get("username") || params.get("user");
  
  if (usernameParam) {
    return usernameParam;
  }
  
  const usuarioLogadoJSON = localStorage.getItem('usuarioLogado');
  if (usuarioLogadoJSON) {
    const usuarioLogado = JSON.parse(usuarioLogadoJSON);
    return usuarioLogado.username;
  }
  
  return null;
}

// ===================
// CARREGAR PERFIL COMPLETO
// ===================
async function carregarPerfilCompleto() {
  const usernameParaCarregar = determinarUsuarioParaCarregar();
  
  if (!usernameParaCarregar) {
    console.log("Nenhum usuário para carregar");
    window.location.href = 'index.html';
    return;
  }

  console.log("Carregando perfil do usuário:", usernameParaCarregar);

  try {
    const userRef = doc(db, "users", usernameParaCarregar);
    const docSnap = await getDoc(userRef);

    if (docSnap.exists()) {
      const dados = docSnap.data();
      console.log("Dados do usuário carregados:", dados);
      
      atualizarInformacoesBasicas(dados, usernameParaCarregar);
      atualizarVisaoGeral(dados);
      atualizarGostos(dados);
      atualizarImagensPerfil(dados);
      
    } else {
      console.log("Usuário não encontrado no banco de dados");
      const nomeElement = document.getElementById("nomeCompleto");
      if (nomeElement) nomeElement.textContent = "Usuário não encontrado";
      const usernameElement = document.getElementById("username");
      if (usernameElement) usernameElement.textContent = "";
    }
  } catch (error) {
    console.error("Erro ao carregar perfil:", error);
  }
}

// ===================
// FUNÇÕES DE ATUALIZAÇÃO (mantidas iguais)
// ===================
function atualizarInformacoesBasicas(dados, username) {
  const nomeCompleto = dados.displayname || `${dados.nome || ''} ${dados.sobrenome || ''}`.trim();
  const nomeElement = document.getElementById("nomeCompleto");
  if (nomeElement) {
    nomeElement.textContent = nomeCompleto || "Nome não disponível";
  }

  const usernameElement = document.getElementById("username");
  if (usernameElement) {
    usernameElement.textContent = `@${dados.username || username}`;
  }

  const tituloMural = document.getElementById("tituloMural");
  if (tituloMural) {
    tituloMural.textContent = `Mural de ${nomeCompleto || dados.username || username}`;
  }

  const visaoGeralTitle = document.getElementById("visao-geral-title");
  if (visaoGeralTitle) {
    visaoGeralTitle.textContent = `Visão Geral de ${nomeCompleto || dados.username || username}`;
  }

  if (dados.pronoun1 || dados.pronoun2) {
    const pronomes = `${dados.pronoun1 || ''}/${dados.pronoun2 || ''}`.replace(/^\/|\/$/g, '');
    const handleElement = document.querySelector('.handle');
    if (handleElement && pronomes) {
      handleElement.innerHTML = `@${dados.username || username} • ${pronomes}`;
    }
  }
}

function atualizarVisaoGeral(dados) {
  const visaoTab = document.querySelector('.visao-tab .about-container');
  if (!visaoTab) return;

  const aboutBoxes = visaoTab.querySelectorAll('.about-box');
  
  if (aboutBoxes[0]) {
    const visaoGeral = dados.visaoGeral || "Informação não disponível";
    aboutBoxes[0].innerHTML = `<p><i>Visão geral:</i></p><p>${visaoGeral}</p>`;
  }

  if (aboutBoxes[1]) {
    const tags = dados.tags || "Informação não disponível";
    aboutBoxes[1].innerHTML = `<p><i>Tags:</i></p><p>${tags}</p>`;
  }

  if (aboutBoxes[2]) {
    const estilo = dados.estilo || "Informação não disponível";
    aboutBoxes[2].innerHTML = `<p><i>Meu Estilo:</i></p><p>${estilo}</p>`;
  }

  if (aboutBoxes[3]) {
    const personalidade = dados.personalidade || "Informação não disponível";
    aboutBoxes[3].innerHTML = `<p><i>Minha personalidade:</i></p><p>${personalidade}</p>`;
  }

  if (aboutBoxes[4]) {
    const sonhos = dados.sonhos || "Informação não disponível";
    aboutBoxes[4].innerHTML = `<p><i>Meus Sonhos e desejos:</i></p><p>${sonhos}</p>`;
  }

  if (aboutBoxes[5]) {
    const medos = dados.medos || "Informação não disponível";
    aboutBoxes[5].innerHTML = `<p><i>Meus Medos:</i></p><p>${medos}</p>`;
  }
}

function atualizarGostos(dados) {
  const gostosTab = document.querySelector('.gostos-tab .about-container');
  if (!gostosTab) return;

  const aboutBoxes = gostosTab.querySelectorAll('.about-box');

  if (aboutBoxes[0]) {
    const musicas = dados.musicas || "Informação não disponível";
    aboutBoxes[0].innerHTML = `<p><i>Músicas:</i></p><p>${musicas}</p>`;
  }

  if (aboutBoxes[1]) {
    const filmesSeries = dados.filmesSeries || "Informação não disponível";
    aboutBoxes[1].innerHTML = `<p><i>Filmes e Séries:</i></p><p>${filmesSeries}</p>`;
  }

  if (aboutBoxes[2]) {
    const livros = dados.livros || "Informação não disponível";
    aboutBoxes[2].innerHTML = `<p><i>Livros:</i></p><p>${livros}</p>`;
  }

  if (aboutBoxes[3]) {
    const personagens = dados.personagens || "Informação não disponível";
    aboutBoxes[3].innerHTML = `<p><i>Personagens:</i></p><p>${personagens}</p>`;
  }

  if (aboutBoxes[4]) {
    const comidas = dados.comidas || "Informação não disponível";
    aboutBoxes[4].innerHTML = `<p><i>Comidas e Bebidas:</i></p><p>${comidas}</p>`;
  }

  if (aboutBoxes[5]) {
    const hobbies = dados.hobbies || "Informação não disponível";
    aboutBoxes[5].innerHTML = `<p><i>Hobbies:</i></p><p>${hobbies}</p>`;
  }

  if (aboutBoxes[6]) {
    const jogos = dados.jogos || "Informação não disponível";
    aboutBoxes[6].innerHTML = `<p><i>Jogos favoritos:</i></p><p>${jogos}</p>`;
  }

  if (aboutBoxes[7]) {
    const outrosGostos = dados.outrosGostos || "Informação não disponível";
    aboutBoxes[7].innerHTML = `<p><i>Outros gostos:</i></p><p>${outrosGostos}</p>`;
  }
}

function atualizarImagensPerfil(dados) {
  const profilePic = document.querySelector('.profile-pic');
  if (profilePic) {
    if (dados.userphoto || dados.foto) {
      profilePic.src = dados.userphoto || dados.foto;
      profilePic.onerror = () => {
        profilePic.src = './src/icon/default.jpg';
      };
    } else {
      profilePic.src = './src/icon/default.jpg';
    }
  }

  const userPics = document.querySelectorAll('.user-pic');
  userPics.forEach(pic => {
    if (dados.userphoto || dados.foto) {
      pic.src = dados.userphoto || dados.foto;
      pic.onerror = () => {
        pic.src = './src/icon/default.jpg';
      };
    } else {
      pic.src = './src/icon/default.jpg';
    }
  });

  if (dados.backgroundphoto || dados.imagemFundo) {
    const profileHeader = document.querySelector('.profile-header');
    if (profileHeader) {
      const backgroundUrl = dados.backgroundphoto || dados.imagemFundo;
      profileHeader.style.backgroundImage = `url(${backgroundUrl})`;
      profileHeader.style.backgroundSize = 'cover';
      profileHeader.style.backgroundPosition = 'center';
      profileHeader.style.position = 'relative';
      profileHeader.style.backgroundAttachment = 'scroll';
    }
    
    const backgroundElements = document.querySelectorAll('.background-image, .hero-bg, .banner-bg');
    backgroundElements.forEach(element => {
      element.style.backgroundImage = `url(${backgroundUrl})`;
      element.style.backgroundSize = 'cover';
      element.style.backgroundPosition = 'center';
    });
  }

  if (dados.headerphoto) {
    const headerImages = document.querySelectorAll('.header-image, .banner-image, .cover-photo');
    headerImages.forEach(img => {
      if (img.tagName === 'IMG') {
        img.src = dados.headerphoto;
        img.onerror = () => {
          img.src = './src/bg/bg.jpg';
        };
      } else {
        img.style.backgroundImage = `url(${dados.headerphoto})`;
        img.style.backgroundSize = 'cover';
        img.style.backgroundPosition = 'center';
      }
    });
    
    if (!dados.backgroundphoto && !dados.imagemFundo) {
      const profileHeader = document.querySelector('.profile-header');
      if (profileHeader) {
        profileHeader.style.backgroundImage = `url(${dados.headerphoto})`;
        profileHeader.style.backgroundSize = 'cover';
        profileHeader.style.backgroundPosition = 'center';
      }
    }
  }

  const usernameSpans = document.querySelectorAll('.username');
  const displayName = dados.displayname || dados.username;
  usernameSpans.forEach(span => {
    if (displayName) {
      span.textContent = displayName;
    }
  });
}

function configurarLinks() {
  const usuarioLogadoJSON = localStorage.getItem('usuarioLogado');
  if (usuarioLogadoJSON) {
    const usuarioLogado = JSON.parse(usuarioLogadoJSON);
    const username = usuarioLogado.username;
    
    const urlPerfil = `PF.html?username=${encodeURIComponent(username)}`;
    
    const linkSidebar = document.getElementById('linkPerfilSidebar');
    const linkMobile = document.getElementById('linkPerfilMobile');
    
    if (linkSidebar) linkSidebar.href = urlPerfil;
    if (linkMobile) linkMobile.href = urlPerfil;
  }

  const btnSair = document.getElementById('btnSair');
  if (btnSair) {
    btnSair.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'index.html';
    });
  }
}

async function atualizarMarqueeUltimoUsuario() {
  try {
    const lastUpdateRef = doc(db, "lastupdate", "latestUser");
    const docSnap = await getDoc(lastUpdateRef);

    const marquee = document.querySelector(".marquee");
    if (!marquee) return;

    if (docSnap.exists()) {
      const data = docSnap.data();
      const nomeUsuario = data.username || "Usuário";
      marquee.textContent = `${nomeUsuario} acabou de entrar no RealMe!`;
    } else {
      marquee.textContent = "Bem-vindo ao RealMe!";
    }
  } catch (error) {
    console.error("Erro ao buscar último usuário:", error);
    const marquee = document.querySelector(".marquee");
    if (marquee) marquee.textContent = "Erro ao carregar dados.";
  }
}

function verificarLogin() {
  const usuarioLogado = localStorage.getItem('usuarioLogado');
  if (!usuarioLogado) {
    console.log("Usuário não está logado, redirecionando para login");
    window.location.href = 'index.html';
    return false;
  }
  return true;
}

// ===================
// INICIALIZAÇÃO
// ===================
let liveStatusManager = null;

window.addEventListener("DOMContentLoaded", async () => {
  console.log("Carregando página de perfil...");
  
  if (!verificarLogin()) {
    return;
  }
  
  // Inicializar Live Status
  const usuarioLogadoJSON = localStorage.getItem('usuarioLogado');
  if (usuarioLogadoJSON) {
    const usuarioLogado = JSON.parse(usuarioLogadoJSON);
    liveStatusManager = new LiveStatusManager(usuarioLogado.username);
  }
  
  await carregarPerfilCompleto();
  await atualizarMarqueeUltimoUsuario();
  configurarLinks();
  
  console.log("Página de perfil carregada com sucesso!");
});

// Cleanup ao sair da página
window.addEventListener('beforeunload', () => {
  if (liveStatusManager) {
    liveStatusManager.destroy();
  }
});

// ===================
// CSS PARA STATUS INDICATOR
// ===================
const statusCSS = `
<style>
.status-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 8px;
}

.status-indicator.online {
  background-color: #28a745;
  animation: pulse 2s infinite;
}

.status-indicator.away {
  background-color: #ffc107;
}

.status-indicator.offline {
  background-color: #dc3545;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.status-text.online {
  color: #28a745;
  font-weight: bold;
}

.status-text.away {
  color: #ffc107;
  font-weight: bold;
}

.status-text.offline {
  color: #dc3545;
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', statusCSS);
</script>
</body>
</html>