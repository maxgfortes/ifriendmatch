<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Criar Conta - iFriendMatch</title>
  <link rel="icon" href="./src/icon/icon.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <meta name="theme-color" content="#1F1F1F" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./src/icon/icon.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-image: url("src/bg/bg.jpg");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
      color: #dbdbdb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    body::-webkit-scrollbar {
      display: none;
    }

    .glass-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      background: #000000cc;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      width: 100%;
      max-width: 480px;
      margin-top: 300px;
        background: rgba(20, 20, 20, 0.247);
  backdrop-filter: blur(8px);
  border: 1px solid #2a2a2a;
  border-radius: 12px;
    }

    h1 {
      text-align: center;
      color: #f7f7f7;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.2px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    label {
      font-size: 14px;
      color: #bbb;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: linear-gradient(337deg, rgba(19, 19, 19, 1) 0%, rgba(26, 26, 26, 1) 100%);
      color: #ddd;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      width: 100%;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: #0084ff;
      box-shadow: 0 0 5px #0084ff;
      background: #1a1a1a;
      color: #fff;
    }

    select {
      cursor: pointer;
    }

button {
  display: inline-block;
  background-color: #4A90E2;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  text-decoration: none;
  border-top: 1px solid #63a9fa;
  transition: background-color 0.3s;
  border: none;
}

button:hover {
  background-color: #357ABD;
}

    @media (max-width: 480px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
    }

    nav {
      background: #1C1C1C;
      background: linear-gradient(0deg, #141414 0%, #1F1F1F 100%);
      border-bottom: 1px solid #121212;
      display: flex;
      align-items: center;
      padding: 0px 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.5);
    }

    .logo {
      font-weight: bold;
      font-size: 30px;
      color: #707070;
      padding: 10px;
    }

    .logo_area{
      padding: 0px;
      padding-right: 35px;
      padding-left: 20px;
    }
    .link {
      text-align: center;
      margin-top: 10px;
    }

    .link a {
      color: #0084ff;
      text-decoration: none;
      font-weight: bold;
    }

    .link a:hover {
      text-decoration: underline;
    }

input:-webkit-autofill {
  display: flex !important;
  align-items: center !important;
  background: #000000 !important;
  border-radius: 8px !important;
  border: 1px solid #242424 !important;
  box-shadow: inset 0 8px 8px -7px rgba(0, 0, 0, 0.644) !important;
  color: #dbdbdb !important;
  padding: 10px 15px !important;
  font-size: 16px !important;
  outline: none !important;
  width: 100% !important;

  -webkit-box-shadow: 0 0 0 1000px #474747 inset !important; /* fundo */
  -webkit-text-fill-color: #dbdbdb !important;              /* texto */
}

/* Autofill Firefox */
input:-moz-autofill {
  display: flex !important;
  align-items: center !important;
  background: #474747 !important;
  border-radius: 8px !important;
  border: 1px solid #363636 !important;
  box-shadow: inset 0 8px 8px -7px rgba(0, 0, 0, 0.644) !important;
  color: #dbdbdb !important;
  padding: 10px 15px !important;
  font-size: 16px !important;
  outline: none !important;
  width: 100% !important;

  box-shadow: 0 0 0 1000px #474747 inset !important;
  -moz-text-fill-color: #dbdbdb !important;
}
  </style>
</head>
<body>

  <nav>
    <div class="logo_area">
      <div class="logo">RealMe</div>
    </div>
  </nav>

  <div class="container">
    <h1>Criar Conta</h1>
    <form>
      <div>
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" placeholder="Seu nome" required />
      </div>
      <div>
        <label for="sobrenome">Sobrenome</label>
        <input type="text" id="sobrenome" name="sobrenome" placeholder="Seu sobrenome" required />
      </div>
      <div>
        <label for="usuario">Nome de Usuário</label>
        <input type="text" id="usuario" name="usuario" placeholder="Escolha um nome de usuário" required />
      </div>
      <div>
        <label for="idade">Idade</label>
        <input type="number" id="idade" name="idade" min="10" max="120" placeholder="Sua idade" required />
      </div>
      <div>
        <label for="sobrenome">E-mail</label>
        <input type="text" id="email" name="email" placeholder="meunome@email.com" required />
      </div>
      
      <div>
        <label for="genero">Gênero</label>
        <select id="genero" name="genero" required>
          <option value="" disabled selected>Selecione o gênero</option>
          <option value="masculino">Masculino</option>
          <option value="feminino">Feminino</option>
          <option value="outro">Outro</option>
          <option value="prefiro_nao_dizer">Prefiro não dizer</option>
        </select>
      </div>
      <div>
        <label for="senha">Senha</label>
        <input type="password" id="senha" name="senha" placeholder="Crie uma senha" required minlength="6" />
      </div>
      <button type="submit">Criar Conta</button>
    </form>
    <div class="link">
      <p>já tem uma conta? <a href="login.html">Entrar</a></p>
    </div>
  </div>

   <div class="glass-overlay"></div>

<script type="module">
// Importações do Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

// Configurações do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB2N41DiH0-Wjdos19dizlWSKOlkpPuOWs",
  authDomain: "ifriendmatch.firebaseapp.com",
  projectId: "ifriendmatch",
  storageBucket: "ifriendmatch.appspot.com",
  messagingSenderId: "306331636603",
  appId: "1:306331636603:web:c0ae0bd22501803995e3de",
  measurementId: "G-D96BEW6RC3"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const analytics = getAnalytics(app);

// ===================
// FUNÇÃO PARA ATUALIZAR ÚLTIMO USUÁRIO
// ===================
async function atualizarUltimoUsuario(username) {
  try {
    const lastUpdateRef = doc(db, "lastupdate", "latestUser");
    
    await setDoc(lastUpdateRef, {
      username: username,
      timestamp: serverTimestamp(),
      acao: "conta_criada"
    });
    
    console.log("Último usuário atualizado para:", username);
  } catch (error) {
    console.error("Erro ao atualizar último usuário:", error);
    // Não interrompe o processo se houver erro no marquee
  }
}

// ===================
// FUNÇÃO PARA CRIAR CONTA (ATUALIZADA)
// ===================
async function criarConta(event) {
  event.preventDefault();

  // Força o username em minúsculo
  let username = document.getElementById('usuario').value.trim().toLowerCase();
  const nome = document.getElementById('nome').value.trim();
  const sobrenome = document.getElementById('sobrenome').value.trim();
  const email = document.getElementById('email').value.trim();
  const idade = parseInt(document.getElementById('idade').value.trim());
  const genero = document.getElementById('genero').value;
  const senha = document.getElementById('senha').value.trim();

  // Validação básica
  if (!username || !nome || !sobrenome || !email || !idade || !genero || !senha) {
    alert("Preencha todos os campos.");
    return;
  }

  // Validações adicionais
  if (username.length < 3) {
    alert("Nome de usuário deve ter pelo menos 3 caracteres.");
    return;
  }

  if (!/^[a-zA-Z0-9_]+$/.test(username)) {
  alert("Nome de usuário só pode conter letras, números e underline (_).");
  return;
}

  if (senha.length < 6) {
    alert("Senha deve ter pelo menos 6 caracteres.");
    return;
  }

  if (idade < 13 || idade > 120) {
    alert("Idade deve estar entre 13 e 120 anos.");
    return;
  }

  // Validação de email básica
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert("Digite um email válido.");
    return;
  }

  try {
    // Verificar se o username já existe
    const userRef = doc(db, "users", username);
    const docSnap = await getDoc(userRef);

    if (docSnap.exists()) {
      alert("Nome de usuário já está em uso. Tente outro.");
      return;
    }

    // Gerar UID único baseado em timestamp
    const uid = Date.now();

    // Criar o documento do usuário
    await setDoc(userRef, {
      username: username,
      nome: nome,
      sobrenome: sobrenome,
      email: email,
      idade: idade,
      genero: genero,
      password: senha, // Em produção, hash a senha!
      uid: uid,
      criadoem: serverTimestamp(),
      
      // Campos padrão para o perfil
      displayname: `${nome} ${sobrenome}`,
      userphoto: "./src/icon/default.jpg",
      backgroundphoto: "",
      headerphoto: "",
      
      // Campos de perfil opcionais (vazios inicialmente)
      visaoGeral: "",
      tags: "",
      estilo: "",
      personalidade: "",
      sonhos: "",
      medos: "",
      musicas: "",
      filmesSeries: "",
      livros: "",
      personagens: "",
      comidas: "",
      hobbies: "",
      jogos: "",
      outrosGostos: ""
    });

    console.log("Conta criada com sucesso para:", username);

    // *** ATUALIZAR ÚLTIMO USUÁRIO NO MARQUEE ***
    await atualizarUltimoUsuario(username);

    // Sucesso - limpar formulário e redirecionar
    alert("Conta criada com sucesso! Você será redirecionado para o login.");
    document.querySelector('form').reset();

    // Redireciona para a página de login após 1 segundo
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1000);

  } catch (error) {
    console.error("Erro ao criar conta:", error);
    
    // Mensagem de erro mais específica
    if (error.code === 'permission-denied') {
      alert("Erro de permissão. Verifique as configurações do Firebase.");
    } else if (error.code === 'network-error') {
      alert("Erro de conexão. Verifique sua internet e tente novamente.");
    } else {
      alert("Erro ao criar conta. Tente novamente em alguns instantes.");
    }
  }
}

// ===================
// FUNÇÃO PARA VALIDAR ENTRADA DO USERNAME EM TEMPO REAL
// ===================
function configurarValidacaoUsername() {
  const usernameInput = document.getElementById('usuario');
  if (usernameInput) {
    usernameInput.addEventListener('input', function() {
      // Forçar minúsculo e remover espaços
      this.value = this.value.toLowerCase().replace(/\s/g, '');
      
      // Remover caracteres especiais (manter apenas letras, números e _)
      this.value = this.value.replace(/[^a-z0-9_]/g, '');
      
      // Feedback visual
      if (this.value.length < 3) {
        this.style.borderColor = '#ff6b6b';
      } else {
        this.style.borderColor = '#51cf66';
      }
    });
  }
}

// ===================
// FUNÇÃO PARA VALIDAR IDADE
// ===================
function configurarValidacaoIdade() {
  const idadeInput = document.getElementById('idade');
  if (idadeInput) {
    idadeInput.addEventListener('input', function() {
      const idade = parseInt(this.value);
      
      if (isNaN(idade) || idade < 13 || idade > 120) {
        this.style.borderColor = '#ff6b6b';
      } else {
        this.style.borderColor = '#51cf66';
      }
    });
  }
}

// ===================
// FUNÇÃO PARA VALIDAR EMAIL
// ===================
function configurarValidacaoEmail() {
  const emailInput = document.getElementById('email');
  if (emailInput) {
    emailInput.addEventListener('blur', function() {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!emailRegex.test(this.value)) {
        this.style.borderColor = '#ff6b6b';
      } else {
        this.style.borderColor = '#51cf66';
      }
    });
  }
}

// ===================
// FUNÇÃO DE INICIALIZAÇÃO
// ===================
function inicializar() {
  // Configurar validações em tempo real
  configurarValidacaoUsername();
  configurarValidacaoIdade();
  configurarValidacaoEmail();
  
  // Adicionar evento ao formulário
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', criarConta);
    console.log("Sistema de criação de conta inicializado");
  } else {
    console.error("Formulário não encontrado");
  }
}

// ===================
// INICIALIZAÇÃO QUANDO DOM CARREGA
// ===================
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', inicializar);
} else {
  inicializar();
}

// Também adicionar para compatibilidade
window.addEventListener('load', inicializar);
</script>

</body>
</html>
